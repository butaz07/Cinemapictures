@model Cinemapictures.Models.Entities.Invoice

@{ ViewData["Title"] = "Crear Factura"; }

<h1>Crear Factura</h1>

<h4>Factura</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="ClientId" class="control-label">Cliente</label>
                <select asp-for="ClientId" class="form-control" asp-items="@(ViewData["ClientId"] as Microsoft.AspNetCore.Mvc.Rendering.SelectList)">
                    <option value="">-- Seleccione un Cliente --</option>
                </select>
                <span asp-validation-for="ClientId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="EmployeeId" class="control-label">Empleado</label>
                <select asp-for="EmployeeId" class="form-control" asp-items="@(ViewData["EmployeeId"] as Microsoft.AspNetCore.Mvc.Rendering.SelectList)">
                    <option value="">-- Seleccione un Empleado --</option>
                </select>
                <span asp-validation-for="EmployeeId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="MovieId" class="control-label">Película</label>
                <select asp-for="MovieId" id="MovieId" class="form-control" asp-items="@(ViewData["MovieId"] as Microsoft.AspNetCore.Mvc.Rendering.SelectList)">
                    <option value="">-- Seleccione una Película --</option>
                </select>
                <span asp-validation-for="MovieId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label for="NumberOfDays" class="control-label">Cantidad de Días</label>
                <input id="NumberOfDays" name="NumberOfDays" type="number" value="1" min="1" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="Subtotal" class="control-label"></label>
                <input asp-for="Subtotal" class="form-control" readonly />
                <span asp-validation-for="Subtotal" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="TotalTax" class="control-label"></label>
                <input asp-for="TotalTax" class="form-control" readonly />
                <span asp-validation-for="TotalTax" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Date" class="control-label"></label>
                <input asp-for="Date" class="form-control" />
                <span asp-validation-for="Date" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="TotalAmount" class="control-label"></label>
                <input asp-for="TotalAmount" class="form-control" readonly />
                <span asp-validation-for="TotalAmount" class="text-danger"></span>
            </div>

            <div class="form-group mt-3">
                <input type="submit" value="Crear" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">Volver a la Lista</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const moviePrices = JSON.parse('@Html.Raw(ViewData["MoviePrices"])');
            const movieSelect = document.getElementById('MovieId');
            const numberOfDaysInput = document.getElementById('NumberOfDays');
            const subtotalInput = document.getElementById('Subtotal');
            const totalTaxInput = document.getElementById('TotalTax');
            const totalAmountInput = document.getElementById('TotalAmount');
            const taxRate = 0.18;

            function calculateTotals() {
                const movieId = movieSelect.value;
                const numberOfDays = numberOfDaysInput.value;
                let subtotal = 0;

                if (movieId && numberOfDays) {
                    const dailyCost = moviePrices[movieId];
                    if (dailyCost) {
                        subtotal = dailyCost * numberOfDays;
                    }
                }
                
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                subtotalInput.value = subtotal.toFixed(2);
                totalTaxInput.value = tax.toFixed(2);
                totalAmountInput.value = total.toFixed(2);
            }

            movieSelect.addEventListener('change', calculateTotals);
            numberOfDaysInput.addEventListener('input', calculateTotals);

            calculateTotals();
        });
    </script>
}
